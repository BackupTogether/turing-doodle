<!doctype html>
<html lang="en">

<head>
    <title>Turing Machine!</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="web-fonts-with-css/css/fontawesome-all.min.css">
</head>

<body>
    <div class="container">
        <br>
        <div class="row justify-content-between">
            <h3 class="col">这是一条纸带，单击某一位可改变其初始值</h3>
            <button type="button" class="btn btn-info col-2" onclick="addTapeCell()">增加纸带长度</button>
        </div>
        <div class="btn-group" role="group" id="tape">
            <button type="button" id="0" class="btn btn-secondary" onclick="flip(this)">0</button>
            <button type="button" id="1" class="btn btn-secondary" onclick="flip(this)">0</button>
            <button type="button" id="2" class="btn btn-secondary" onclick="flip(this)">0</button>
            <button type="button" id="3" class="btn btn-secondary" onclick="flip(this)">0</button>
            <button type="button" id="4" class="btn btn-secondary" onclick="flip(this)">0</button>
        </div>
        <br>
        <br>
        <div class="form-group form-inline">
            <label for="initial">初始状态：</label>
            <input class="form-control" id="initial" value="Q1"></input>
            <label for="current">当前状态：</label>
            <input class="form-control" id="current" disabled></input>
            <label for="pos">当前指针：</label>
            <input class="form-control" id="pos" value="0"></input>
        </div>
        <!-- <div class="form-group">
            <label for="machine">请输入状态转移矩阵：</label>
            <textarea class="form-control" id="machine" rows="3">[[[1,1,"→"],null],[[0,0,"→"],null]]</textarea>
        </div> -->
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">
                        <button type="button" class="btn btn-light" onclick="addRule()"><i class="far fa-plus-square fa-lg"></i></button>
                        <!-- <i class="fas fa-plus-square" onclick="addRule()"></i> -->
                        <!-- <i class="far fa-plus-square fa-lg" onclick="addRule()"></i> -->
                    </th>
                    <th scope="col">当前状态</th>
                    <th scope="col">纸带当前位置的值</th>
                    <th scope="col">状态转移</th>
                </tr>
            </thead>
            <tbody id="rule">
                <tr id="row1">
                    <th scope="row">1</th>
                    <td>
                        <input type="text" class="form-control rule-from-status" placeholder="当前状态">
                    </td>
                    <td>
                        <input type="text" class="form-control rule-from-tape" placeholder="纸带当前位置的值">
                    </td>
                    <td class="form-inline">
                        <input type="text" class="form-control col-4 rule-to-status" placeholder="下一状态">
                        <input type="text" class="form-control col-4 rule-to-tape" placeholder="纸带变成">
                        <!-- <input type="text" class="form-control col-4 rule-index-move" placeholder="指针移动"> -->
                        <div class="form-group form-inline col-4">
                            <label>指针移动：</label>
                            <select class="form-control rule-index-move">
                                <option value="L">左移</option>
                                <option value="S" selected="selected">不动</option>
                                <option value="R">右移</option>
                            </select>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="form-group">
            <label for="accept">请输入 Accept 集（英文逗号分隔）：</label>
            <textarea class="form-control" id="accept" rows="2">Q2</textarea>
        </div>
        <div class="form-group">
            <label for="reject">请输入 Reject 集（英文逗号分隔）：</label>
            <textarea class="form-control" id="reject" rows="2">Q3</textarea>
        </div>
        <div>
            <button type="button" class="btn btn-success" onclick="run()">运行</button>
            <button type="button" class="btn btn-warning" onclick="stop()">停止运行</button>
            <!-- <button type="button" class="btn btn-success" onclick="getRules()">查看当前规则</button> -->
            <div class="btn-group" role="group" id="demo">
            </div>
        </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="bootstrap/jquery-3.2.1.slim.min.js"></script>
    <script src="bootstrap/popper.min.js"></script>
    <script src="bootstrap/bootstrap.min.js"></script>
    <script type="text/javascript">
    accept = [];
    reject = [];
    rule_machine = {};
    index = 0;
    current = 0;
    s = {};
    demo = [
        { "button": "加载 Accept 示例", "rule_machine": { "Q0": { "0": { "rule_to_status": "Q1", "rule_to_tape": "1", "rule_index_move": "R" }, "1": { "rule_to_status": "Q0", "rule_to_tape": "1", "rule_index_move": "R" } }, "Q1": { "0": { "rule_to_status": "Q2", "rule_to_tape": "0", "rule_index_move": "L" }, "1": { "rule_to_status": "Q1", "rule_to_tape": "1", "rule_index_move": "R" } }, "Q2": { "1": { "rule_to_status": "Q3", "rule_to_tape": "0", "rule_index_move": "L" } } }, "accept": ["Q3"], "reject": ["Q4"], "tape": [1, 1, 1, 0, 1, 1, 0, 0], "initial": "Q0", "index": 0 },
        { "button": "加载永不停机示例", "rule_machine": { "Q0": { "0": { "rule_to_status": "Q0", "rule_to_tape": "1", "rule_index_move": "R" }, "1": { "rule_to_status": "Q0", "rule_to_tape": "0", "rule_index_move": "R" } } }, "accept": ["Q1"], "reject": ["Q2"], "tape": [1, 1, 0, 1, 0, 1], "initial": "Q0", "index": 0 },
        { "button": "加载 Reject 示例", "rule_machine": { "Q0": { "1": { "rule_to_status": "Q4", "rule_to_tape": "0", "rule_index_move": "R" } }, "Q1": { "0": { "rule_to_status": "Q4", "rule_to_tape": "0", "rule_index_move": "R" }, "1": { "rule_to_status": "Q2", "rule_to_tape": "1", "rule_index_move": "R" } }, "Q2": { "0": { "rule_to_status": "Q3", "rule_to_tape": "0", "rule_index_move": "R" }, "1": { "rule_to_status": "Q4", "rule_to_tape": "1", "rule_index_move": "R" } } }, "accept": ["Q3"], "reject": ["Q4"], "tape": [1, 1, 1, 1, 0], "initial": "Q0", "index": 0 }
    ];

    $(document).ready(function() {
        for (var i = 0; i < demo.length; i++) {
            $("#demo").append('<button type="button" id="demo' + i + '" class="btn btn-outline-info" onclick="loadDemo(' + i + ')">' + demo[i].button + '</button>');
        }
    });

    function loadDemo(i) {
        rule_machine = demo[i].rule_machine;
        $("#rule").text("");
        for (key in rule_machine) {
            for (tape_value in rule_machine[key]) {
                $("#rule").append('<tr id="row' + ($("#rule").children().length + 1) + '"><th scope="row">' + ($("#rule").children().length + 1) + '</th><td><input type="text" class="form-control rule-from-status" placeholder="当前状态" value="' + key + '"></td><td><input type="text" class="form-control rule-from-tape" placeholder="纸带当前位置的值" value="' + tape_value + '"></td><td class="form-inline"><input type="text" class="form-control col-4 rule-to-status" placeholder="下一状态" value="' + rule_machine[key][tape_value]["rule_to_status"] + '"><input type="text" class="form-control col-4 rule-to-tape" placeholder="纸带变成" value="' + rule_machine[key][tape_value]["rule_to_tape"] + '"><div class="form-group form-inline col-4"><label>指针移动：</label><select class="form-control rule-index-move"><option value="L" ' + ((rule_machine[key][tape_value]["rule_index_move"] == "L") ? ' selected="selected"' : '') + '>左移</option><option value="S" ' + ((rule_machine[key][tape_value]["rule_index_move"] == "S") ? ' selected="selected"' : '') + '>不动</option><option value="R" ' + ((rule_machine[key][tape_value]["rule_index_move"] == "R") ? ' selected="selected"' : '') + '>右移</option></select></div></td></tr>');
            }
        }
        $("#accept").val(demo[i].accept);
        $("#reject").val(demo[i].reject);
        $("#initial").val(demo[i].initial);
        $("#pos").val(demo[i].index);
        $("#tape").text("");
        for (var j = 0; j < demo[i].tape.length; j++) {
            $("#tape").append('<button type="button" id="' + $("#tape").children().length + '" class="btn btn-secondary" onclick="flip(this)">' + demo[i].tape[j] + '</button>');
        }
    }

    function flip(cell) {
        if (cell.innerHTML == 0) {
            cell.innerHTML = 1;
        } else if (cell.innerHTML == 1) {
            cell.innerHTML = 0;
        }
    }

    function run() {
        if (!getRules()) {
            console.log("信息输入有误，取消执行");
        }
        $("#current").val(initial);
        $("#" + index).removeClass("btn-secondary").addClass("btn-primary");
        s = setInterval(change, 1000);
    }

    function getRules() {
        rule_machine = {};
        for (var i = 1; i <= $("#rule").children().length; i++) {
            var key_status = $("tr#row" + i + " .rule-from-status").val();
            var key_tape = $("tr#row" + i + " .rule-from-tape").val();
            if (key_status == "") {
                alert("状态机输入有误：当前状态不能为空！");
                return false;
            }
            var next_status = {};
            next_status.rule_to_status = $("tr#row" + i + " .rule-to-status").val();
            next_status.rule_to_tape = $("tr#row" + i + " .rule-to-tape").val();
            next_status.rule_index_move = $("tr#row" + i + " .rule-index-move").val();
            if (rule_machine[key_status] == null) {
                rule_machine[key_status] = {};
            }
            if (rule_machine[key_status][key_tape] == null) {
                rule_machine[key_status][key_tape] = next_status;
            } else {
                alert("状态机输入有误：同一状态且纸带值相同时，有多种状态转移！");
                return false;
            }
        }
        console.log(rule_machine);
        console.log(JSON.stringify(rule_machine));
        accept = $("#accept").val().split(",");
        reject = $("#reject").val().split(",");
        console.log(accept);
        console.log(reject);
        for (var i = 0; i < accept.length; i++) {
            if ($.inArray(accept[i], reject) != -1) {
                alert("状态 " + accept[i] + " 同时出现在 Accept 集和 Reject 集中！");
                return false;
            }
        }
        for (key in rule_machine) {
            rule_set = rule_machine[key];
            for (rule_key in rule_set) {
                rule = rule_set[rule_key];
                if (rule_machine[rule.rule_to_status] == null && $.inArray(rule.rule_to_status, reject) == -1 && $.inArray(rule.rule_to_status, accept) == -1) {
                    alert("状态 " + key + " 的下游状态 " + rule.rule_to_status + " 不存在！");
                    return false;
                }
            }
        }
        initial = "" + $("#initial").val();
        current = initial;
        if (rule_machine[initial] == null) {
            alert("初始状态不在状态机中！");
            return false;
        }
        index = parseInt($("#pos").val());
        if (index < 0) {
            alert("当前指针不能是负数！");
            return false;
        } else if (index >= $("#tape").children().length) {
            alert("当前指针超过纸带长度，请先增加纸带长度！");
            return false;
        }
        return true;
    }

    function change() {
        value_on_tape = $("#" + index).text();
        if ($.inArray(current, reject) != -1) {
            alert("Rejected!");
            stop();
            return;
        } else if ($.inArray(current, accept) != -1) {
            alert("Accepted!");
            stop();
            return;
        }
        $("#current").val(rule_machine[current][value_on_tape].rule_to_status);
        $("#" + index).text(rule_machine[current][value_on_tape].rule_to_tape);
        console.log("Change: " + rule_machine[current][value_on_tape].rule_index_move);
        $("#" + index).removeClass("btn-primary").addClass("btn-secondary");
        if (rule_machine[current][value_on_tape].rule_index_move == "R") {
            index = index + 1;
        } else if (rule_machine[current][value_on_tape].rule_index_move == "L") {
            index = index - 1;
        }
        if (index == $("#tape").children().length) {
            addTapeCell();
        }
        current = "" + $("#current").val();
        $("#" + index).removeClass("btn-secondary").addClass("btn-primary");
        $("#pos").val(index);
    }

    function addTapeCell() {
        $("#tape").append('<button type="button" id="' + $("#tape").children().length + '" class="btn btn-secondary" onclick="flip(this)">0</button>');
    }

    function addRule(argument) {
        $("#rule").append('<tr id="row' + ($("#rule").children().length + 1) + '"><th scope="row">' + ($("#rule").children().length + 1) + '</th><td><input type="text" class="form-control rule-from-status" placeholder="当前状态"></td><td><input type="text" class="form-control rule-from-tape" placeholder="纸带当前位置的值"></td><td class="form-inline"><input type="text" class="form-control col-4 rule-to-status" placeholder="下一状态"><input type="text" class="form-control col-4 rule-to-tape" placeholder="纸带变成"><div class="form-group form-inline col-4"><label>指针移动：</label><select class="form-control rule-index-move"><option value="L">左移</option><option value="S" selected="selected">不动</option><option value="R">右移</option></select></div></td></tr>');
    }

    function stop() {
        $("#" + index).removeClass("btn-primary").addClass("btn-secondary");
        current = "";
        clearInterval(s);
    }
    </script>
</body>

</html>